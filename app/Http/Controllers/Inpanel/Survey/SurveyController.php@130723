<?php

namespace App\Http\Controllers\Inpanel\Survey;

use App\Events\Inpanel\Project\ProfileSurveyAttempted;
use App\Events\Inpanel\Project\ProfileSurveyComplete;
use App\Events\Inpanel\Project\StartSurvey;
use App\Http\Controllers\Inpanel\DashboardController;
use Illuminate\Support\Facades\Session;
use App\Models\Auth\User;
use App\Repositories\Frontend\Auth\UserRepository;
use App\Repositories\Inpanel\Profiler\ProfileSectionRepository;
use App\Repositories\Inpanel\Project\ProjectRepository;
use Hash;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use App\Repositories\Inpanel\Traffic\TrafficStatuses;
use Carbon\Carbon;


/**
 * This class is used for handling Survey Functionality to take survey, view the available surveys, completed surveys.
 *
 * Class SurveyController
 * @author Pankaj Jha
 * @author Akash Sharma
 * @access public
 * @package App\Http\Controllers\Inpanel\Survey\SurveyController
 */

class SurveyController extends Controller
{

    /**
     * @param TrafficStatuses
     * @param $userRepository,$projectRepo
     */
    use TrafficStatuses;
    protected $userRepository, $projectRepo;

    /**
     * SurveyController constructor.
     *
     * @param UserRepository $userRepository
     * @param ProjectRepository $projectRepo
     */
    public function __construct(UserRepository $userRepository, ProjectRepository $projectRepo)
    {
        $this->userRepository = $userRepository;
        $this->projectRepo = $projectRepo;
    }

    /**
     * This action is used to redirect the user to the view of Survey Index page where
     * user can check all the available surveys and could take surveys.
     *
     * @return resource survey/index.blade.php
     */
    public function index(Request $request)
    {
        $user = auth()->user();
        if($request->get('sort')){
            //print_r($request->get('sort'));die;
            $sorting = $request->get('sort');
            $surveys = $userProject = $this->projectRepo->getActiveUserProjectByUserId($user->id,$sorting);
        }else{
            $surveys = $userProject = $this->projectRepo->getActiveUserProjectByUserId($user->id); 
        }

       // print_r($surveys);die;
        //$surveys = $userProject = $this->projectRepo->getActiveUserProjectByUserId($user->id);
        $status = $this->getTrafficStatuses($status_id = null);
        $profile_repo = new ProfileSectionRepository();
        $detailed_profile_survey = $profile_repo->getDetailedProfileSurvey();

        return view('inpanel.survey.index', compact('surveys','detailed_profile_survey'))
            ->with('status',$status);
    }

    /**
     * This action is used to redirect to the view of History of all the surveys that had been taken.
     *
     * @return resource survey/history.blade.php
     */
    public function history()
    {
        $user = auth()->user();
        
         $timezone=$user->timezone;
       
        $surveys = $userProject = $this->projectRepo->getUserTakenSurveys($user->id);
        $status = $this->getTrafficStatuses($status_id = null);
        return view('inpanel.survey.history', compact('surveys'))
        ->with('timezone',$timezone)
        ->with('status',$status);
    }

    /**
     * This action is used to handle the functionality of Starting the Surveys and redirecting the user
     * to the client redirect link.
     *
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse
     * @return $client_new_redirect_link
     */
    public function startSurvey(Request $request)
    {
        $user = auth()->user();
        $survey_id = $request->survey_id;
        Session::forget('status');
        if($user && $survey_id){
            $user_project_details = $this->projectRepo->getProjectDetails($survey_id,$user);
            if($user_project_details && $user_project_details->project->isLive()){
                $change_Status = $this->projectRepo->changeStatus($user_project_details);
                if($change_Status){
                    event(new ProfileSurveyAttempted($user));
                    $client_new_redirect_link = $this->projectRepo->getRedirectClientLink($user,$user_project_details);
                    if($client_new_redirect_link){
                        //print_r($client_new_redirect_link);die;
                        return redirect()->to($client_new_redirect_link);
                    }
                }
            }else{
                return \Redirect::back()
                    ->withErrors('You have already attempted the survey. Please refresh the page.');
            }
        }
    }

    /**
     * This action is used to handle the Functionality of end surveys by receiving the status and details of
     * the user and surveys and marking the status the status as per received.
     *
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function endSurvey(Request $request)
    {
        $sjpid = $request->input('sjpid', false);
        $user_data = explode('_',$sjpid);
        $user_project_code = $user_data[1];
        $user_uuid = $user_data[0];
        $status = $request->input('status', false);
        $checksum = $request->input('hash', false);
       // $checksum_validate = $this->hashValidate($checksum,$request->getRequestUri());
       $checksum_validate = true;
        $user = $this->projectRepo->getUserDetails($user_uuid);
        $project = $this->projectRepo->getProject($user_project_code);
        if($user && $project){
            $get_user_project = $this->projectRepo->getUserProject($user,$project);
            if($get_user_project){
                if(!$checksum_validate){
                    $status = 4;
                    $this->projectRepo->changeStatusQualityTerminate($get_user_project);
                }else{
                    if($status==1){
                        $this->projectRepo->changeStatusComplete($get_user_project);
                        $this->projectRepo->updateUserAchievements($user,$get_user_project);
                        event(new ProfileSurveyComplete($user));
                    } elseif ($status==2){
                        $this->projectRepo->changeStatusTerminate($get_user_project);
                    } elseif($status==3){
                        $this->projectRepo->changeStatusQuotaFull($get_user_project);
                    }
                }
                return view('inpanel.survey.survey_end_page')
                    ->with('user_project',$get_user_project)
                    ->with('status',$status);
            }
        }
        return redirect()->route('inpanel.survey.index');
    }

    private function hashValidate($checksum,$url)
    {
        $url_explode = explode('?',$url);
        $url_explode = explode('&',$url_explode[1]);
        foreach($url_explode as $i => $val){
            list($k, $v) = explode('=', $val);
            if(substr($val,-1)=='='){
                $v.='=';
            }
            $result[ $k ] = $v;
        }
        $parameters = $result;
        $checksumValue = $parameters[config('app.vvars.checksum')];
        //print_r($checksumValue); echo '<br>';
        $raw_url = '';
        $raw_url = explode( $checksumValue, $url)[0];
        //print_r($raw_url); echo '<br>';
        $raw_url = explode('&'.config('app.vvars.checksum').'='.$checksumValue, $url )[0];
        //print_r($raw_url); echo '<br>';
        $raw_url = explode('?', $raw_url)[1];
        //print_r($raw_url); echo '<br>';
        $SJChecksumValue = hash_hmac( 'sha1', $raw_url, 'r7UrrUpUyBX');
        //print_r($SJChecksumValue); echo '<br>';

        //print_r($checksumValue);die;
        if($SJChecksumValue !== $checksumValue){
            return false;
        }else{
            return true;
        }
    }
}
