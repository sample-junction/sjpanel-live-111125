@extends('backend.layouts.app')

@section('title', app_name() . ' | ' . __('labels.backend.access.reports.titles.panelist_management'))

@section('breadcrumb-links')
    @include('backend.auth.user.includes.breadcrumb-links')
@endsection

@section('content')
<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-sm-5">
                <h4 class="card-title mb-0">
                @lang('labels.backend.access.reports.titles.panelist_management') 
                <!-- <small class="text-muted">Active Users</small> -->
                </h4><br>
                <h5 class="text-muted">Total panelists : <b>{{count($activeUsers)}}</b></h5>
            </div><!--col-->
            <div class="col-sm-7">
                <a href="{{route('admin.auth.panelist')}}" class="btn btn-info" style="float: right;margin-left: 10px;">Reset</a>&nbsp;&nbsp;
                <button type="button" class="btn btn-info" style="float: right;" data-toggle="modal" data-target="#bulkSearch">Bulk Search</button>&nbsp;&nbsp;
                <!-- <a href="{{route('admin.auth.user.exportUserProfile')}}" class="btn btn-info" style="float: right;margin-right: 10px;">Export Profiles</a> -->
                <button type="button" class="btn btn-info" style="float: right;margin-right: 10px;" data-toggle="modal" data-target="#exportProfileData">Export Profiles </button>
                <button type="button" class="btn btn-info" style="float: right;margin-right: 11px" data-toggle="modal" data-target="#bulkimport">Bulk Mark Fraud </button>
            </div>
            
        </div><!--row-->

        <div class="row mt-4">
            <div class="col">
                <div class="table-responsive">
                    <table class="table" id="user_management">
                        <thead>
                        <tr>
                            <th>@lang('labels.backend.access.users.table.uuid')</th>
                            <th>@lang('labels.backend.access.users.table.panelistid')</th>
                            <!-- <th>@lang('labels.backend.access.users.table.age')</th> -->
                            <!-- <th>@lang('labels.backend.access.users.table.gender')</th> -->
                            <th>Fraud Count</th>
                            <th>Project Code</th>
                            <th>Action</th>
                            
                        </tr>
                        </thead>
                        <tbody>
                        @foreach($activeUsers as $user)
                        @php
                        //echo '<pre>';
                        //print_r($user);
                        @endphp
                        
                            <tr>
                                <input type="hidden" name="userIDS[]" class="userclass" value="{{$user->id}}" >
                                <td>{{ $user->uuid }}</td>
                                <td>{{ $user->panellist_id }}</td>
                                <!-- <td>{{ $user->gender }}</td> -->
                                <td>{{ ($user->fraudcount)?$user->fraudcount:0 }}</td>
                                <td>{{ implode(", ",explode(",",$user->projectcode)) }}</td>
                                @if($date=='')
                                @if($user->fraudcount >= $getFraudLimit->value && $user->is_blacklist == 1)
                                <td><span class="btn-sm btn-danger">Blacklisted</span></td>
                                @else
                                <!-- <td><button type="button" class="btn btn-warning" onclick="insertFraud('{{ $user->panellist_id }}')">Fraud</button></td> -->
                                <td><button type="button" class="btn-sm btn-warning" onclick="openPopup('{{ $user->panellist_id }}')">Fraud</button></td>
                                @endif
                                @else
                                <td></td>
                                @endif
                                

                            </tr>
                        @endforeach
                        </tbody>
                    </table>
                </div>
            </div><!--col-->
        </div><!--row-->
        
    </div><!--card-body-->
</div><!--card-->

<!--Bulk Search  -->
<div class="modal fade in bulkSearch" tabindex="-1" role="dialog" id="bulkSearch" aria-labelledby="inviteSetting-1" aria-hidden="true">
    <div class="modal-dialog modal-lg invite_setting_modal link_modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search</h5>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button> <h3 class="modal-title"></h3>
            </div>
            <form action="{{route('admin.auth.user.fraud')}}" method="post">
                @csrf
                <div class="modal-body invite_setting">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <span>Search Type</span>
                                <select name="searchType" id="searchType" class="form-control" required>
                                    <option value="">Select Search Type</option>
                                    <option value="uuid">UUID</option>
                                    <option value="panelists_id">Panellists Id</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="form-group">
                                <span>Userids</span>
                                <textarea name="userids" class="form-control" placeholder="Enter Data (ex-1,2,3,4)"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <button type ="submit" class="btn btn-primary" style="margin-right: 20px;" >Apply</button>
                    </div>
                </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal-->

<!------Popup Comment----------->
<div class="modal fade in popupComment" tabindex="-1" role="dialog" id="popupComment" aria-labelledby="inviteSetting-1" aria-hidden="true">
    <div class="modal-dialog invite_setting_modal link_modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Fraud</h5>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick="closePopup()">x</button> <h3 class="modal-title"></h3>
            </div>
                <div class="modal-body invite_setting">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <span>Project Code</span>
                                <!-- <select name="searchType" id="searchType" class="form-control" required>
                                    <option value="">Select Search Type</option>
                                    <option value="uuid">UUID</option>
                                    <option value="panelists_id">Panelists Id</option>
                                </select> -->
                                <input type="text" id="projectid" class="form-control" required>
                                <input type="hidden" id="panelistsId" class="form-control">
                                <input type="hidden" id="managerId" class="form-control" value="{{ $userid }}">
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="form-group">
                                <span>Reason</span>
                                <textarea id="reason" class="form-control" placeholder="Enter Reason"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <button type ="submit" class="btn btn-primary" style="margin-right: 20px;" onclick="insertFraud()">Apply</button>
                    </div>
                </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal-->

<!-- Bulk Upload mark fraud -->
<div class="modal fade in bulkimport" tabindex="-1" role="dialog" id="bulkimport" aria-labelledby="inviteSetting-1" aria-hidden="true">
    <div class="modal-dialog modal-lg invite_setting_modal link_modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Upload Excel(Only CSV)</h5>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button> <h3 class="modal-title"></h3>
            </div>
            <form action="{{route('admin.auth.user.importFraudUser')}}" method="post" enctype="multipart/form-data">
                @csrf
                <div class="modal-body invite_setting">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <a href="{{asset('demofraud/Sample_fraud_users.csv')}}">Download Sample Excel</a>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="form-group">
                                <span>Upload Excel (Only CSV)</span><br>
                                <input type="file" name="importfile" id="importfile" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <button type ="submit" class="btn btn-primary" style="margin-right: 20px;" >Upload</button>
                    </div>
                </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal-->

<!--Export Profile Data -->
<div class="modal fade in exportProfileData" tabindex="-1" role="dialog" id="exportProfileData" aria-labelledby="inviteSetting-1" aria-hidden="true">
    <div class="modal-dialog modal-lg invite_setting_modal link_modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Profile</h5>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button> <h3 class="modal-title"></h3>
            </div>
            <form action="{{route('admin.auth.user.exportUserProfile')}}" method="post">
                @csrf
                <div class="modal-body invite_setting">
                    <div class="row">
                        <!-- <div class="col-sm-6">
                            <div class="form-group">
                                <span>Search Type</span>
                                <select name="searchType" id="searchType" class="form-control" required>
                                    <option value="">Select Search Type</option>
                                    <option value="uuid">UUID</option>
                                    <option value="panelists_id">Panellists Id</option>
                                </select>
                            </div>
                        </div> -->
                        <div class="col-sm-12">
                            <div class="form-group">
                                <span>Panellist Ids</span>
                                <textarea name="panellist_ids" class="form-control" placeholder="Panellist Ids (ex-1,2,3,4)" required></textarea>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <span>Country Code</span>
                                <select name="country_code" id="country_code" class="form-control" required>
                                    <option value="US">US</option>
                                    <option value="IN">IN</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="row">
                            <div class="col-sm-12">{!! BootForm::label('Profile Section','Profile Section'); !!} </div>
                            
                                <div class="col-sm-6">
                                    
                                    {!! BootForm::checkbox('all_profile','All Profiles', 'all_profiles',false ,array('id'=>'allprofile')); !!}
                                    {!! BootForm::checkbox('profile_section[]','Basic', 'BASIC',false ,array('class'=>'allselect')); !!}
                                    {!! BootForm::checkbox('profile_section[]','My Profile', 'MY_PROFILE',false ,array('class'=>'allselect')); !!}
                                    {!! BootForm::checkbox('profile_section[]','Family', 'FAMILY', false ,array('class'=>'allselect')); !!}
                                    {!! BootForm::checkbox('profile_section[]','Automotive', 'AUTOMOTIVE', false ,array('class'=>'allselect')); !!}
                                    {!! BootForm::checkbox('profile_section[]','Employment', 'EMPLOYMENT', false ,array('class'=>'allselect')); !!}
                                </div>
                                <div class="col-sm-6">
                                   
                                    {!! BootForm::checkbox('profile_section[]','Travel / Leisure', 'TRAVEL_/_LEISURE', false ,array('class'=>'allselect')); !!}
                                    {!! BootForm::checkbox('profile_section[]','Internet / Games / Sports', 'INTERNET_/_GAMES_/_SPORTS',false ,array('class'=>'allselect')); !!}
                                    {!! BootForm::checkbox('profile_section[]','Health / Food', 'HEALTH_/_FOOD', false ,array('class'=>'allselect')); !!}
                                    {!! BootForm::checkbox('profile_section[]','Technology', 'TECHNOLOGY', false ,array('class'=>'allselect')); !!}
                                    {!! BootForm::checkbox('profile_section[]','Hidden', 'HIDDEN', false ,array('class'=>'allselect')); !!}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <button type ="submit" class="btn btn-primary" style="margin-right: 20px;" id="exportData" >Export</button>
                    </div>
                </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal-->
@endsection

@push('after-styles')
    <link rel="stylesheet" href="{{ asset('css/datatable.css') }}" >
@endpush
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.4.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap4.min.css">
@push('after-scripts')
    {{-- For DataTables --}}
    <script type="text/javascript" src="{{ asset('js/dataTable.js') }}"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.4.1/js/dataTables.buttons.min.js"></script>
    <script src="//cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="//cdn.datatables.net/buttons/2.2.3/js/buttons.bootstrap4.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="//cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#user_management').DataTable({
                serverSide: false,
                stateSave: true,
                destroy: true,
                'processing': true,
                dom: 'Bfrtip',
                lengthMenu: [
                    [25, 50, 100, -1],
                    [25, 50, 100,'All'],
                ],
                buttons: [
                    'excel', 'csv'
                ],
            });
            $(".dataTables_wrapper").css("width","100%");
            setTimeout(callerFunction, 4000);
        } );
    </script>
    <script>
        function openPopup(panelistsId){
            $('#popupComment').modal('show');
            $('#panelistsId').val(panelistsId);
            
        }

        var callerFunction = function(){
  //alert("Execution point!");
  console.log("Execution point!");
  userIds=[];
  $('.userclass').each(function(){
    var ids=$(this).val();
    userIds.push(ids);

  });
  console.log(userIds);
  
  $.ajax({
                /* the route pointing to the post function */
                url: "{{route('admin.auth.user.updatenotification')}}",
                type: 'POST',
                /* send the csrf-token and the input to the controller */
                data: {_token: "{{ csrf_token() }}", userIds : userIds },
                dataType: 'JSON',
                /* remind that 'data' is the response of the AjaxController */
                success: function (response) { 
                    console.log(response);
                    try{
                        if (response.status === 200) {
                           // swal('Fraud action successfully');
                            console.log("Notification updated");

                            //swal({text: "Fraud action successfully"}).then(function(){ location.reload();});
                           
                        }
                    }catch(error){
                        swal({text: "Some error occure!", type: "error"});
                    } 
                }
            });
}


        function insertFraud(){
            var panelistsId = $('#panelistsId').val();
            var managerId   = $('#managerId').val();
            var projectid   = $('#projectid').val();
            var reason      = $('#reason').val();
            
           // alert(panelistsId);
           // alert(managerId);
           // alert(projectid);
           // alert(reason);
            $.ajax({
                /* the route pointing to the post function */
                url: "{{route('admin.auth.user.insertfraud')}}",
                type: 'POST',
                /* send the csrf-token and the input to the controller */
                data: {_token: "{{ csrf_token() }}", panelistsId : panelistsId , managerId : managerId , projectid : projectid , reason : reason},
                dataType: 'JSON',
                /* remind that 'data' is the response of the AjaxController */
                success: function (response) { 
                    console.log(response);
                    try{
                        if (response.status === 200) {
                           // swal('Fraud action successfully');
                            $('#panelistsId').val('');
                            $('#managerId').val('');
                            $('#projectid').val('');
                            $('#reason').val('');

                            swal({text: "Fraud action successfully"}).then(function(){ location.reload();});
                           
                        }
                    }catch(error){
                        swal({text: "Some error occure!", type: "error"});
                    } 
                }
            }); 
        }

        function closePopup(){
            $('#popupComment').modal('hide');
        }

        $('#exportData').click(function(){
            setTimeout(function () {
                location.reload(true);
            }, 2000);
            
        });
    
       $('#allprofile').click(function(){
            if($(this).is(':checked')){
                $(".allselect").prop('checked',true)
            }else{
                $(".allselect").prop('checked',false)
            }

       }); 
        
    </script>
@endpush
