@extends('inpanel.layouts.device')
@push('after-styles')
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="{{asset('css2/detail_profile_inpage.css')}}" rel="stylesheet">
		
	<style type="text/css">	
	@php
		if(app()->getLocale() == 'en_US'){
	@endphp
		.li-list-item-7 {
			left: 79% !important;
		}
	@php
		}else if(app()->getLocale() == 'es_US'){
	@endphp
		.li-list-item-7 {
			left: 77% !important;
		}
	@php
		}else if(app()->getLocale() == 'en_CA'){
	@endphp
		.li-list-item-7 {
			left: 77% !important;
		}
	@php
		}else{
	@endphp
	
		.li-list-item-7 {
			/*left: 75% !important;*/
		}
	@php
		}
	@endphp
	.update-button {
		padding: 10px !important;
	}

    /* CSS added by Vikas for scroller on Profile section (starting) */
    .tab-scroll-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        padding: 0 40px; /* Leave space for arrows on both sides */
    }

    .li-tab-row {
        overflow-x: auto;
        white-space: nowrap;
        scroll-behavior: smooth;
        width: 100%;
        padding: 10px 0;
        position: relative;
    }

    /* Scroll Buttons */
    .scroll-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        border: none;
        font-size: 22px;
        z-index: 10;
        cursor: pointer;
        padding: 6px 12px;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        transition: background 0.3s ease;
    }

    .scroll-btn:hover {
        background: #f0f0f094;
    }

    .scroll-left {
        left: 0;
        margin-left: -11px; /* Moves the button slightly out of wrapper */
    }

    .scroll-right {
        right: 0;
        margin-right: -11px;
    }

    /* Gradient Overlay on Right */
    .li-tab-row::after {
        content: "";
        position: absolute;
        right: 0;
        top: 0;
        width: 60px;
        height: 100%;
        background: linear-gradient(to left, white, transparent);
        pointer-events: none;
        z-index: 5;
    }
    @media (max-width: 768px) {
        .scroll-btn {
            font-size: 18px;
            padding: 4px 10px;
        }

        .tab-scroll-wrapper {
            padding: 0 25px;
        }

        .scroll-left {
            margin-left: -15px;
        }

        .scroll-right {
            margin-right: -15px;
        }
    }
    /* Ending */

</style>
@endpush
<!-- Parshant Sharma [21-08-2024] STARTS -->
@php
	//$metricConversion = round(1/$countryPoints, 4);
	$metricConversion = 1/$countryPoints;
	//dd($metricConversion);
@endphp	

<!-- Parshant Sharma [21-08-2024] ENDS -->
@section('detailProfile_select','cst-active')
@section('content')
    <div class="row mt-5">
        <div class="col-12">
            <p class="h4 ms-2" style="font-weight: 600;">
                {!!__('inpanel.profile.index.page_heading')!!}
            </p>
        </div>
    </div>
    <div class="row mt-3 mb-2 ms-lg-2 me-lg-2">
        <div class="col-12 col-lg-6 pt-1" style="background: #fbf2e3;">
            <p class="pt-3 ps-2" style="font-size: 13px;">
                {!!__('inpanel.profile.index.total_points_message')!!}
            </p>
        </div>
        <div class="col-12 col-lg-6 mt-2 mt-lg-0" style="background: #246efd;">
            
            <div class="row ps-2 pe-2 ps-lg-0 pe-lg-0 pt-3 pb-3">
                <div class="col-12 col-lg-6 text-lg-center pb-3 pb-lg-0  earned-points">
                    <span class="text-light earned-text">
						@php
                            $convertedValue = $filledProfilesCount * $metricConversion;
                        @endphp

                        {{ __('inpanel.profile.index.credit_points') }}: {{ $filledProfilesCount }}
                        @if($convertedValue < 1)
                            @php
                                $cents = round($convertedValue * 100);
                                $currency = ($cents > 1) ? $currencies['currency_denom_plural'] : $currencies['currency_denom_singular'];
                            @endphp
                            ({{ $cents }} {{ __($currency) }})
                        @else
                            ({{ $currencies['currency_logo'] }}{{ number_format($convertedValue, 2) }})
                        @endif

                    </span>
                </div>
            
                <div class="col-12 col-lg-6 text-lg-center pb-1 pt-3 pt-lg-0 remaining-points">
                    <span class="text-light remaining-text">
						@php
                            $remainingPoints = $allPointsCount - $filledProfilesCount;
                            $convertedValue = $remainingPoints * $metricConversion;
                        @endphp

                        {{ __('inpanel.profile.index.remaining_points') }}: {{ $remainingPoints }}

                        @if($convertedValue < 1)
                            @php
                                $cents = round($convertedValue * 100);
                                $currency = ($cents > 1) ? $currencies['currency_denom_plural'] : $currencies['currency_denom_singular'];
                            @endphp
                            ({{ $cents }} {{ __($currency) }})
                        @else
                            ({{ $currencies['currency_logo'] }}{{ number_format($convertedValue, 2) }})
                        @endif

                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="row p-lg-3">
        @php

        $complete_arr = [];
        foreach($completedProfiles as $completed){
            array_push($complete_arr, $completed->doTranslate('text'));
        }
        @endphp

         <input type="hidden" name="filled_count" id="filled_count" value="{{implode(",",$complete_arr)}}">
         <input type="hidden" name="locale" id="locale" value="{{app()->getLocale()}}" >
        <!--<div class="col cst-bg-hot-survey bg-white shadow" style="border-radius: 10px;">-->

		<div class="col cst-bg-hot-survey bg-white shadow" style="border-radius: 10px !important; --bs-bg-opacity: 1; background-color: rgba(var(--bs-white-rgb), var(--bs-bg-opacity)) !important; box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;">

            <div class="tab-scroll-wrapper position-relative">
                <button class="scroll-btn scroll-left" onclick="scrollTabs(-200)">&#10094;</button>

                <div class="row p-3 border-bottom li-tab-row cst-menu-tab-mob">
                    @if( !empty($profile_sections) )
                        @foreach($profile_sections as $sections)
                            @php
                                $translated = $sections->doTranslate();
                                $title =  $sections->doTranslate('text') ;
                                $class_item = '';
                                if($tke_survey_id){
                                    $class_item = 'li-list-item-'.$loop->iteration;
                                    if($sections->_id == $tke_survey_id[0]){
                                        $class_item .= ' cst-survey-filter-active';
                                    }
                                }else{
                                    if($loop->iteration == 1){
                                        $class_item = 'cst-survey-filter-active';
                                    }else{
                                        $class_item = 'li-list-item-'.$loop->iteration;
                                    }
                                }
                            @endphp

                            @if(in_array($sections->doTranslate('text'),$complete_arr))
                                <span class="lead filter-survey-li {{$class_item}}" onclick="loadSurveyEss('{{ $loop->iteration }}')">
                                    {{ $sections->doTranslate('text') }}
                                    <img src="{{ asset('images/verified.png') }}" alt="Icon" width="20px" class="img-fluid me-3" />
                                </span>
                            @else
                                <span class="lead filter-survey-li {{$class_item}}" onclick="loadSurveyEss('{{ $loop->iteration }}')">
                                    {{ $sections->doTranslate('text') }}
                                </span>
                            @endif
                        @endforeach
                    @endif
                </div>

                <button class="scroll-btn scroll-right" onclick="scrollTabs(200)">&#10095;</button>
            </div>
            @php $i = 1; @endphp
            @foreach($profile_sections as $sections)
                @php
                $class_item_sr = '';
                if($tke_survey_id){
                    if($sections->_id != $tke_survey_id[0]){
                        $class_item_sr = 'hid';
                    }
                }else{
                    if($loop->iteration != 1){
                        $class_item_sr = 'hid';
                    }
                }
                
                $data_sr = 'data-sr-'.$loop->iteration;
                $load_data = 'loadData-'.$loop->iteration;
                $dependency_data = 'dependency-'.$sections->_id;
                @endphp
                <div id="filter-content-survey" class="{{$class_item_sr}}" data-sr="{{$data_sr}}">
                            
                    <div class="progress mt-4" style="height: 10px;" role="progressbar" aria-label="Success example" aria-valuenow="{{ $filledProfilesCount/8}}" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar" style="width: {{ $filledProfilesCount/8}}%; height: 10px; background: #25A76E;">
                        
                        </div>
                    </div>
                    <div class="row pt-4 profile_ques_data">
                    <p id="edit-alert-{{$sections->_id}}" class="edit-alert-message d-none" style="color: red; text-align:center; font-size: 16px; line-height: 1.5;">
                                {{ __('inpanel.basic_detail.edit_alert_message') }}
                            </p>
                        <div class="col-12 mt-3 load_{{$sections->_id}}" id="{{$load_data}}">

                        </div>
                        @if(in_array($sections->doTranslate('text'),$complete_arr))
                            @php
                                // Check if this section has any filled answer
                                $hasEditData = false;
                                foreach($filled_pro_survey as $f_pro_sur) {
                                    if($f_pro_sur->doTranslate('text') == $sections->doTranslate('text')) {
                                        foreach($f_pro_sur->questions as $ques) {
                                            if(!empty($ques->userAnswers)) {
                                                $hasEditData = true;
                                                break 2; // break both loops once data is found
                                            }
                                        }
                                    }
                                }
                            @endphp


                        <div id="before_edit_{{$sections->_id}}" style="">
                        @if($hasEditData)
                            <p id="edit-alert-{{$sections->_id}}" class="edit-alert-message" style="color: red; text-align:center; font-size: 16px; line-height: 1.5;">
                                {{ __('inpanel.basic_detail.edit_alert_message') }}
                            </p>
                        @endif
                            
                            @foreach($filled_pro_survey as $f_pro_sur)
                                @if($f_pro_sur->doTranslate('text') == $sections->doTranslate('text'))
                                    @foreach(collect($f_pro_sur->questions)->sortBy('order') as $index=> $filled_ques)
                                        @if($filled_ques->userAnswers)
                                            @php
                                            $ans_index = json_decode($filled_ques->userAnswers)->user_answer;
                                            $ans_index_arr = array_map('intval',explode(',',$ans_index));
                                            $quesdata = $filled_ques->doTranslate('answers');
                                            $m = 1;
                                            $answer = '';
                                            if ($ans_index_arr !== null && is_array($quesdata)){
                                                foreach($ans_index_arr as $ind){
                                                    if (isset($quesdata[$ind - 1])) {
                                                        // Hide Vistara option if current date is after November 2025 Added by Vikas
                                                        if($filled_ques->id == 'STANDARD_INTERNATIONAL_AIRLINES' && 
                                                        now() > Carbon\Carbon::create(2025, 11, 1) && 
                                                        (strpos($quesdata[$ind - 1]['text'], 'Vistara') !== false || 
                                                        strpos($quesdata[$ind - 1]['text'], 'विस्तारा') !== false)) {
                                                            continue;
                                                        }
                                                        $answer .= $m < count($ans_index_arr) ? $quesdata[$ind - 1]['text'] . ';' : $quesdata[$ind - 1]['text'];
                                                        $m++;
                                                    }
                                                }
                                            }
										   
                                            @endphp
                                            <div class="row ms-1 me-1">
                                                <div class="col-12 col-lg-6">
                                                    <p class="fw-bold">
                                                        {{ $filled_ques->doTranslate('text') }}
                                                    </p>
                                                </div>
                                                <div class="col-12 col-lg-6 added-answer">
                                                    <p class="fw-bold" style="color:#1080D0; font-size:13px;">
                                                        {{$answer}}
                                                    </p>
                                                </div>
                                            </div>
                                            <hr class="mt-0">
                                        @endif
                                    @endforeach
                                @endif
                            @endforeach
                            <div class="btn-holder">
                                <button id="edit-button_{{$sections->_id}}" 
                                            class="btn btn-primary btn-lg mt-4 w-sm-100 edit-button" 
                                            onclick="switchView('{{$sections->_id}}'); showEditAlert('{{$sections->_id}}')">
                                        {{ __('inpanel.profiler.edit') }}
                                    </button>
                                </div>
                            </div>
                        <div id="after_edit_{{$sections->_id}}" style="display:none;">
                            
                            <form id="pro_form_{{$sections->_id}}" method="post" action="{{route('inpanel.profiler.profile.update', ['id' => $sections->_id])}}">
                                @csrf
                                @foreach($filled_pro_survey as $key=> $f_pro_sur)
                                @if($f_pro_sur->doTranslate('text') == $sections->doTranslate('text'))
                                @php


                                @endphp
                                        @foreach(collect($f_pro_sur->questions)->sortBy('order') as $index=> $filled_ques)
                                            @if($filled_ques->userAnswers)
                                                @php
                                                    $ans_index = json_decode($filled_ques->userAnswers)->user_answer;
                                                    $ans_index_arr = array_map('intval',explode(',',$ans_index));
                                                    $quesdata = $filled_ques->doTranslate('answers');
                                                    $m = 1;
                                                    $answer = '';
                                                    if ($ans_index_arr !== null && is_array($quesdata)){
                                                        foreach($ans_index_arr as $ind){
                                                            if (isset($quesdata[$ind - 1])) {
                                                                $answer .= $m < count($ans_index_arr) ? $quesdata[$ind - 1]['display_name'] . ';' : $quesdata[$ind - 1]['display_name'];
                                                                $m++;
                                                            }
                                                        }
                                                    }
                                                    $select_class = 'select_'.$sections->_id;
                                                    $pro_class = 'profile_questions_'.$sections->_id;
                                                    $multi = '';
                                                    $multiSelectMsg = '';
                                                    if($filled_ques->type == 'Multi Punch'){
                                                        $multi = 'multiple';
                                                        $multiSelectMsg='(' . __('inpanel.profiler.Select_Multiple_Message') . ')';;
                                                    }
                                                @endphp
                                                <input type="hidden" value="{{ $sections->general_name }}" name="profileName"  />
                                                <input type="hidden" name="update_date" value="{{$filled_up_date[$key]}}"/>
                                                <input type="hidden" name="hours_gap" value="{{$filled_hours_gap[$key]}}"/>
                                                <div id="ques_{{$filled_ques->_id}}" class="{{$pro_class}} main_div">
                                                    <div class="col-12 mt-3 text-center">
                                                        <p class="fw-bold" id="ques_txt_{{$filled_ques->_id}}">
                                                            {{$filled_ques->doTranslate('text')}}{{$multiSelectMsg}}
                                                        </p>
                                                    </div>
                                                    <div class="col-12 text-center d-flex justify-content-center testclass" >
                                                        <select class="form-select form-select-lg select-width {{$select_class}} myselect" aria-label="Large select example" id="sel_{{$filled_ques->id}}" name="{{$filled_ques->id}}[]" {{$multi}} required>
                                                            @php  $x = 1;  @endphp
                                                            @if($quesdata !== null && is_array($quesdata))
                                                                @foreach($quesdata as $ans)
                                                                    
                                                                    @if(!($filled_ques->id == 'STANDARD_INTERNATIONAL_AIRLINES' && 
                                                                        now() > Carbon\Carbon::create(2025, 11, 1) && 
                                                                        (strpos($ans['text'], 'Vistara') !== false || 
                                                                        strpos($ans['text'], 'विस्तारा') !== false)))
                                                                        <option value="{{isset($ans['precode']) ? $ans['precode'] : ''}}" data-brand_precode="{{ isset($ans['brand_precode']) ? $ans['brand_precode'] : '' }}" {{in_array(isset($ans['precode']) ? $ans['precode'] : '',$ans_index_arr) ? 'selected' : ''}}>{{$ans['text']}}</option>
                                                                        @php $x++; @endphp
                                                                    @endif
                                                                @endforeach
                                                           @endif
                                                        </select>
                                                    </div>
                                                    <div class="col-12 text-center">
                                                        <small class="text-danger err-handle hid">
                                                            {{__('inpanel.profiler.empty_error')}}
                                                        </small>
                                                    </div>
                                                    <div class="col-12 mt-4 mb-4 text-center d-flex justify-content-center">
                                                        <button type="button" class="btn btn-outline-secondary btn-lg nextDepButton" style="width:150px; background: none; color:black; border:1px solid #1080D0;" onclick="addAnswer('sel_{{$filled_ques->id}}','ques_{{$filled_ques->_id}}','ques_txt_{{$filled_ques->_id}}','{{$load_data}}')">{{__('inpanel.profiler.done')}}</button>
                                                    </div>
                                                    <hr class="q_hr">
                                                </div>
                                            @else
                                                @php
                                                $multiple = '';
                                                $multiSelectMsg = '';
                                                if($filled_ques->type == 'Multi Punch') {
                                                    $multiple = 'multiple';
                                                    $multiSelectMsg = '(' . __('inpanel.profiler.Select_Multiple_Message') . ')';
                                                }
                                                $select_class = 'select_'.$sections->_id;
                                                $pro_class = 'profile_questions_'.$sections->_id;
                                                @endphp
                                                
                                                <input type="hidden" value="{{ $sections->general_name }}" name="profileName" />
                                                <input type="hidden" name="update_date" value="{{$filled_up_date[$key]}}"/>
                                                <input type="hidden" name="hours_gap" value="{{$filled_hours_gap[$key]}}"/>
                                                
                                                @if($filled_ques->doTranslate('text') != '')
                                                    <div id="ques_{{$filled_ques->_id}}" class="{{$pro_class}} unansweredQuestion main_div">
                                                        <div class="col-12 mt-3 text-center">
                                                            <p class="fw-bold" id="ques_txt_{{$filled_ques->_id}}">
                                                                {{$filled_ques->doTranslate('text')}}{{$multiSelectMsg}}
                                                            </p>
                                                        </div>
                                                        <div class="col-12 text-center d-flex justify-content-center testclass">
                                                            <select class="form-select form-select-lg select-width {{$select_class}} myselect" aria-label="Large select example" id="sel_{{$filled_ques->id}}" name="{{$filled_ques->id}}[]" {{$multiple}} required>
                                                                @if($multiple == '')
                                                                <option value=""></option>
                                                                @endif
                                                                @php $x = 1; @endphp
                                                                @if($filled_ques->doTranslate('answers') !== null && is_array($filled_ques->doTranslate('answers')))
                                                                    @foreach($filled_ques->doTranslate('answers') as $ans)
                                                                        <option data-brand_precode="{{ isset($ans['brand_precode']) ? $ans['brand_precode'] : '' }}" value="{{isset($ans['precode']) ? $ans['precode'] : ''}}">{{$ans['text']}}</option>
                                                                        @php $x++; @endphp
                                                                    @endforeach
                                                                @endif
                                                            </select>
                                                        </div>
                                                        <div class="col-12 text-center">
                                                            <small class="text-danger err-handle hid">
                                                                {{__('inpanel.profiler.empty_error')}}
                                                            </small>
                                                        </div>
                                                        <div class="col-12 mt-4 mb-4 text-center d-flex justify-content-center">
                                                            <button type="button" class="btn btn-outline-secondary btn-lg nextDepButton" style="width:150px; background: none; color:black; border:1px solid #1080D0;" onclick="addAnswer('sel_{{$filled_ques->id}}','ques_{{$filled_ques->_id}}','ques_txt_{{$filled_ques->_id}}','{{$load_data}}')">{{__('inpanel.profiler.done')}}</button>
                                                        </div>
                                                        <hr class="q_hr">
                                                    </div>
                                                @endif
                                            @endif
                                        @endforeach
                                        <div class="col-12 mt-3" id="{{$dependency_data}}">

                                        </div>
                                    @endif
                                @endforeach
                                
                                <div class="btn-holder">
                                    <button type="submit" id="update-button_{{$sections->_id}}" onclick="enableAllSelectsBeforeSubmit('{{$sections->_id}}')" class="btn btn-primary btn-lg mt-4 w-sm-100 update-button" style="display:none;" >{{__('inpanel.profiler.save')}}</button>
                                </div>
                            </form>
                        </div>
                        @else
                        <form id="pro_form_{{$sections->_id}}" method="post" action="{{route('inpanel.profiler.profile.save_fetch.show', ['id' => $sections->_id])}}">
                            @csrf
                            @php 
                            $sel_count = 0; 
                            $questions_count = count($profile_surveys[$loop->iteration-1]->questions);

                            @endphp
                            @foreach($profile_surveys[$loop->iteration-1]->questions as $i => $ques)
                                {{--@if(!$ques->dependency)--}}
                                    @php
                                    $multiple = '';
                                    $multiSelectMsg='';
                                    if($ques->type == 'Multi Punch'){
                                        $multiple = 'multiple';
                                        $multiSelectMsg = '(' . __('inpanel.profiler.Select_Multiple_Message') . ')';
                                    }
                                    if($sel_count == 0){
                                        $disabled = '';
                                    }else{
                                        $disabled = 'disabled';
                                    }
                                    @endphp
                                    @if($ques->translated[0]['text']!='')
                                    <div id="ques_{{$ques->_id}}" class="profile_questions_{{$sections->_id}}">
                                        <div class="col-12 mt-3 text-center">
                                            <p class="fw-bold" id="ques_txt_{{$ques->_id}}" @if($sel_count > 0)style="color:#999999;" @endif>
                                                {{$ques->translated[0]['text']}} {{$multiSelectMsg}}
                                            </p>
                                        </div>
                                        <div class="col-12 text-center d-flex justify-content-center">
                                            <select class="form-select form-select-lg select-width select_{{$sections->_id}} myselect" aria-label="Large select example" id="sel_{{$ques->id}}" name="{{$ques->id}}[]" {{$multiple}} required {{$disabled}}>
                                                @if($multiple == '')
                                                <option value=""></option>
                                                @endif
                                               @if(isset($ques->translated))
                                                @foreach($ques->translated as $trans)
                                                    @php $x = 1; @endphp
                                                       @if(isset($trans['answers']))

                                                        @foreach($trans['answers'] as $ans)

                                                            @if(!($ques->id == 'STANDARD_INTERNATIONAL_AIRLINES' && 
                                                                now() > Carbon\Carbon::create(2025, 11, 1) && 
                                                                (strpos($ans['text'], 'Vistara') !== false || 
                                                                strpos($ans['text'], 'विस्तारा') !== false)))
                                                                <option value="{{isset($ans['precode']) ? $ans['precode'] : ''}}" data-brand_precode="{{ isset($ans['brand_precode']) ? $ans['brand_precode'] : '' }}">{{$ans['text']}}</option>
                                                                @php $x++; @endphp
                                                            @endif
                                                        @endforeach
                                                        @endif
                                                    @endforeach
                                               @endif
                                            </select>
                                            {{--<div>
                                                <input required="true" placeholder="Please mention" class="form-control otherInput" id="sel_{{$ques->id}}_SELECT_OTHER" name="{{$ques->id}}_SELECT_OTHER" type="text" value="" style="display:none;">
                                            </div>--}}
                                                    
                                        </div>
                                        @php 
                                        if($sel_count > 0){
                                            $style = "button_disabled";
                                        }else{
                                            $style = "button_enabled";
                                        }
                                        @endphp
                                        <div class="col-12 text-center">
                                            <small class="text-danger err-handle hid">
                                                {{__('inpanel.profiler.empty_error')}}
                                            </small>
                                        </div>

                                        @if($i != ($questions_count -1))
                                        <div class="col-12 mt-4 mb-4 text-center d-flex justify-content-center">
                                            <button type="button" class="btn btn-outline-secondary btn-lg {{$style}} nextDepButton" onclick="addAnswer('sel_{{$ques->id}}','ques_{{$ques->_id}}','ques_txt_{{$ques->_id}}','{{$load_data}}')" {{$disabled}}>{{__('inpanel.profiler.done')}}</button>
                                        </div>
                                        @endif

                                        <hr class="q_hr">
                                    </div>
                                    @endif
                                    <!-- end question  -->
                                    @php $sel_count++; @endphp
                                {{--@endif--}} 
                            @endforeach
                            <div class="col-12 mt-3" id="{{$dependency_data}}">

                            </div>
                            <div class="btn-holder">
                                <button type="submit" id="update-button" class="btn btn-primary btn-lg mt-4 w-sm-100 update-button" >{{__('inpanel.profiler.save')}}</button>
                            </div>
                        </form>
                        @endif
                    </div>
                </div>
            @endforeach
        </div>
    </div>
<!-- New -->
@endsection

@push('after-scripts')
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
    function showEditAlert(sectionId) {
        $('#edit-alert-' + sectionId).removeClass('d-none');
    }
    $(document).ready(function() {
        // Initial load logic
        var strs = $('#filled_count').val();
        var locale = $('#locale').val();
        var myLocale = locale.split('_');
        var myArray = strs.split(',');
        $('.unansweredQuestion').hide();
        
        if (locale == 'en_US') {
            var PrfoleArr = ['My Profile', 'Family', 'Automotive', 'Employment', 'Travel / Leisure', 'Internet / Games / Sports', 'Health / Food', 'Technology'];
        } else if (locale == 'es_US') {
            var PrfoleArr = ['Mi perfil', 'Familia', 'Automotriz', 'Empleo', 'Viajes / Ocio', 'Internet / Juegos / Deportes', 'Salud / Alimentación', 'Tecnologia'];
        } else if (locale == 'en_CA') {
            var PrfoleArr = ['My Profile', 'Family', 'Automobile', 'Employment', 'Travel / Leisure', 'Internet / Games / Sports', 'Health / Food', 'Technology'];
        } else {
            var PrfoleArr = ['Mon profil', 'La famille', 'Automobile', 'Emploi', 'Voyage / Loisirs', 'Internet / Jeux / Sports', 'Santé / Alimentation', 'La technologie'];
        }

        // Initialize Select2
        $("select").select2({
            tags: false,
            tokenSeparators: [',', ' '],
            width: '873px',
            height: '50px',
            closeOnSelect: true,
            language: {
                noResults: function() {
                    return "{{__('inpanel.profile.index.no_result')}}";
                }
            }
        });

        $('select[id*="STANDARD_AUTO_BRANDS"]').each(function() {
            const $brandSelect = $(this);
            const selectId = $brandSelect.attr('id');
            
            if (selectId.includes('STANDARD_AUTO_BRANDS_IN_IN') || selectId.includes('STANDARD_AUTO_BRANDS_CA')) {
                // Trigger change event to filter models
                $brandSelect.trigger('change');
            }
        });

        // Load first incomplete section
        for (i = 0; i < 8; i++) {
            if (jQuery.inArray(PrfoleArr[i], myArray) < 0) {
                loadSurveyEss(i + 1);
                break;
            }
        }

        // Mobile tab scrolling
        $('.cst-menu-tab-mob span').on('click', function() {
            var bar = $('.cst-menu-tab-mob');
            var barWidth = bar.width();
            var barScrollLeft = bar.scrollLeft();
            var barOffset = bar.offset().left;
            var tab = $(this).closest('span');
            var tabOffset = tab.offset().left;
            var tabWidth = tab.outerWidth();
            var scrollOffset = (barWidth / 2) - (tabWidth / 2);
            var scrollTo;

            if (tabOffset < barOffset) {
                scrollTo = barScrollLeft - (barOffset - tabOffset) - scrollOffset;
            } else if (tabOffset + tabWidth > barOffset + barWidth) {
                scrollTo = barScrollLeft + tabOffset + tabWidth - (barOffset + barWidth) + scrollOffset;
            }

            bar.animate({
                scrollLeft: scrollTo
            }, 500);
        });

        // Dependency handling (SAME AS BEFORE)
        var selectFlag = false;
        $('.myselect').each(eachSelect);

        function eachSelect() {
            // First store reference to the current select element
            var $select = $(this);
            
            // Get necessary attributes
            var selectId = $select.attr('id');
            var ques_code = selectId ? selectId.split('_').slice(1).join('_') : '';
            var isProcessing = false;
            var sectionId = $select.data('section-id');

            // Handle change event properly for Select2
            $select.on('change', function(e) {
                if (isProcessing) return;
                isProcessing = true;

                try {
                    var currentValue = $select.val();
                    var originalValue = $select.data('original-value');
                    var isEditMode = $('#after_edit_' + sectionId).is(':visible');

                    // Triggered when brand is selected (Code Added by Vikas-Starting)
                
                    if (selectId.includes('STANDARD_AUTO_BRANDS_IN_IN') || selectId.includes('STANDARD_AUTO_BRANDS_CA')) {
                        const selectedBrandCodes = ($(this).val() || []).map(Number);
                            console.log('selectedBrandCodes',selectedBrandCodes);
                        
                        // Determine the corresponding model select ID
                        let modelSelectId;
                        if (selectId.includes('STANDARD_AUTO_BRANDS_IN_IN')) {
                            modelSelectId = 'CAR_MODEL_US_STANDARD_IN_IN';
                        } else {
                            modelSelectId = 'CAR_MODEL_US_STANDARD_CA';
                        }
                        console.log('modelSelectId',modelSelectId);
                        const modelSelect = $(`select[id*='${modelSelectId}']`);

                        if (!modelSelect.data('original-options')) {
                            const originalOptions = modelSelect.find('option').clone();
                            console.log('originalOptions',originalOptions);

                            modelSelect.data('original-options', originalOptions);
                        }

                        const originalOptions = modelSelect.data('original-options');

                        const filteredOptions = originalOptions.filter(function() {
                            const brandPrecode = parseInt($(this).data('brand_precode'));
                            console.log('brandPrecode',brandPrecode);

                            return (
                                selectedBrandCodes.includes(brandPrecode) || $(this).val() === ""
                            );
                        });

                        modelSelect.empty().append(filteredOptions).val(null).trigger('change');
                    }
                    //Ends (Vikas)

                    // Process dependencies
                    if (typeof processDependencies === 'function') {
                        processDependencies($select, ques_code, currentValue);
                    }

                    // Handle edit mode
                    if (isEditMode && JSON.stringify(currentValue) === JSON.stringify(originalValue)) {
                        if (typeof restoreOriginalValues === 'function') {
                            restoreOriginalValues(sectionId, $select);
                        }
                    }
                } catch (error) {
                    console.error('Error in select change handler:', error);
                } finally {
                    isProcessing = false;
                }
            });
        }


        function processDependencies($select, ques_code, currentValue) {
            var dep_ques = <?php echo json_encode($dependent_survey_ques); ?>;
            var sectionId = $select.data('section-id');
            // Check if any questions depend on this question
            dep_ques.forEach(function(ques) {
                var dep_jsonObj = JSON.parse(ques.dependency || '[]');
                
                dep_jsonObj.forEach(function(dep) {
                    if (dep.question_code === ques_code) {
                        var $dependentQuestion = $('#ques_' + ques._id);
                        var $dependentSelect = $dependentQuestion.find('select');
                        var selectedValues = normalizeSelectedValues(currentValue);
                        var shouldHide = selectedValues.every(val => (dep.precode || []).includes(val));

                        if (shouldHide) {
                            // Store original value before clearing
                            if (!$dependentSelect.data('original-value')) {
                                $dependentSelect.data('original-value', $dependentSelect.val());
                            }
                            // Clear the dependent question
                            $dependentSelect.val(null).trigger('change');
                            $dependentSelect.prop('disabled', true);
                            $dependentQuestion.hide();
                        } else {
                            console.log('no');
                            // Restore if dependency no longer applies
                            var originalValue = $dependentSelect.data('original-value');
                            if (originalValue !== undefined) {
                                $dependentSelect.val(originalValue).trigger('change');
                                $dependentSelect.prop('disabled', false);
                                $dependentQuestion.show();
                            }
                        }
                    }
                });
            });
            updateEditModeButtonVisibility(sectionId);
        }


        function normalizeSelectedValues(values) {
            if (Array.isArray(values)) {
                return values.map(val => parseInt(val, 10)).filter(val => !isNaN(val));
            }
            var parsed = parseInt(values, 10);
            return !isNaN(parsed) ? [parsed] : [];
        }

        function restoreOriginalValues(sectionId, $currentSelect) {
            var $questions = $('.profile_questions_' + sectionId);
            var currentIndex = $questions.index($currentSelect.closest('.profile_questions_' + sectionId));

            var updatedSelects = [];

            $questions.slice(currentIndex + 1).each(function () {
                var $question = $(this);
                var $select = $question.find('select');
                var originalValue = $select.data('original-value');

                if (JSON.stringify($select.val()) !== JSON.stringify(originalValue)) {
                    // Restore value
                    $select.val(originalValue).prop('disabled', false);

                    // Update UI without triggering dependencies
                    $select.trigger('change.select2');

                    updatedSelects.push($select);
                }

                // Re-enable controls and styles
                $question.find('.nextDepButton')
                    .prop('disabled', false)
                    .removeClass('button_disabled')
                    .addClass('button_enabled');

                $question.find('p.fw-bold').css('color', 'black');
            });

            // After batch update, process all dependencies in a lightweight way
            updatedSelects.forEach(function ($select) {
                var selectId = $select.attr('id');
                var ques_code_arr = selectId.split('_');
                var ques_code = ques_code_arr.slice(1).join('_');
                var currentValue = $select.val();

                // Only process dependencies manually
                processDependencies($select, ques_code, currentValue);
            });
        }
    });


    // Load survey section (SAME)
    function loadSurveyEss(str) {
        let s = str;
        let div_data = document.querySelectorAll('#filter-content-survey');
        let fil_m = document.querySelectorAll('.filter-survey-li ');
        
        for (let i = 0; i < div_data.length; i++) {
            if (div_data[i].dataset.sr == 'data-sr-' + str) {
                div_data[i].style.display = 'block';
                div_data[i].classList.remove('hid');
                fil_m[str - 1].classList.add('cst-survey-filter-active');
            } else {
                div_data[i].style.display = 'none';
                div_data[i].classList.add('hid');
                for (let j = 0; j < 8; j++) {
                    if (j != (str - 1)) {
                        fil_m[j].classList.remove('cst-survey-filter-active');
                    }
                }
            }
        }
    }

    function enableNextVisibleQuestion(sectionId, $currentQuestion) {
        // Find all visible unanswered questions in this section
        var $visibleQuestions = $('.profile_questions_' + sectionId)
            .not('.d-none')
            .not(':hidden')
            .filter(function() {
                return $(this).find('select').val() === null || 
                    $(this).find('select').val().length === 0;
            });
        
        var currentIndex = $visibleQuestions.index($currentQuestion);
        
        // Find next visible question
        for (var i = currentIndex + 1; i < $visibleQuestions.length; i++) {
            var $nextQuestion = $($visibleQuestions[i]);
            
            // Enable this question
            $nextQuestion.find('select').prop('disabled', false);
            $nextQuestion.find('p.fw-bold').css('color', 'black');
            $nextQuestion.find('p.fw-bold').css('color', 'black')
                .end().find('.nextDepButton')
                .prop('disabled', false)
                .removeClass('button_disabled')
                .addClass('button_enabled');
            break; // Only enable the first next visible question
        }

    }


    // Add answer to question (SAME)
    function addAnswer(select, question, questionText, loader) {
        var sel_id = select;
        var q_id = question;
        var sel_value = $('#' + sel_id).val();
        var sel_element = document.getElementById(sel_id);
        var sel_options = $('#' + sel_id).select2('data');
        var sel_option_txt = '';
        var classesList = Array.from($('#' + sel_id)[0].classList);


        if (sel_element.multiple) {
            sel_option_txt = sel_options.map(function(option) {
                return option.text;
            }).join(';');
        } else {
            sel_option_txt = sel_options.map(function(option) {
                return option.text;
            });
        }
        
        var q_element = document.getElementById(q_id);
        var q_text_id_value = document.getElementById(questionText).innerText;

        if (sel_value == "" && sel_element.disabled == false) {
            document.getElementById(sel_id).style.border = "1px solid red";
            sel_element.parentElement.nextElementSibling.children[0].classList.remove('hid');
        } else if (sel_value != "" && sel_element.disabled == false) {
            document.getElementById(sel_id).style.border = "1px solid #f8f9fa";
            q_element.classList.add('d-none');
            
            var new_load_html = `<div class="row ms-1 me-1"> 
                                    <div class="col-12 col-lg-6">
                                        <p class="fw-bold">${q_text_id_value}</p>
                                    </div>
                                    <div class="col-12 col-lg-6 added-answer">
                                        <p class="fw-bold" style="color:#1080D0; font-size:13px;">${sel_option_txt}</p>
                                    </div>
                                </div>
                                <hr class="mt-0">`;

            jQuery("#" + loader).append(new_load_html);
            
            // Get the section ID from classes
            var sectionId = classesList.find(cls => cls.startsWith('select_')).split('_')[1];
            
            // Enable the next visible question
            enableNextVisibleQuestion(sectionId, $(q_element));
            updateEditModeButtonVisibility(sectionId);
        }
    }

    function updateEditModeButtonVisibility(sectionId) {
        // Get all visible questions (both answered and unanswered)
        var $allVisibleQuestions = $('.profile_questions_' + sectionId)
            .not('.d-none')
            .not(':hidden');
        
        // Hide all next buttons first
        $('.profile_questions_' + sectionId).find('.nextDepButton').hide();

        // Case 1: Only one question total - hide its button
        if ($allVisibleQuestions.length === 1) {
            $allVisibleQuestions.find('.nextDepButton').hide();
        }
        // Case 2: Multiple questions - show buttons for all except last question
        else if ($allVisibleQuestions.length > 1) {
            $allVisibleQuestions.not(':last').find('.nextDepButton').show();
        }
    }

    // Switch between view and edit modes (MODIFIED - Now all questions enabled)
    function switchView(section_id) {
        $('#before_edit_' + section_id).hide();
        $('#after_edit_' + section_id).show();
        $('#edit-button_' + section_id).hide();
        $('#update-button_' + section_id).show();

        // Batch initialize selects
        $('select.select_' + section_id).each(function() {
            var $select = $(this);
            var originalValue = $select.val();
            
            $select.data({
                'original-value': $select.prop('multiple') && !Array.isArray(originalValue) ? 
                    (originalValue ? [originalValue] : []) : 
                    originalValue,
                'section-id': section_id
            }).prop('disabled', false);
        });


        // Enable first question
        var $firstQuestion = $('.profile_questions_' + section_id).first();
        $firstQuestion.find('p.fw-bold').css('color', 'black')
            .end().find('.nextDepButton')
            .prop('disabled', false)
            .removeClass('button_disabled')
            .addClass('button_enabled');
        updateEditModeButtonVisibility(section_id);

    }

    // Form submission handler (SAME VALIDATION)
    function enableAllSelectsBeforeSubmit(section_id) {
        // First enable all selects
        $('select.select_' + section_id).prop('disabled', false);
        
        // Then validate
        let isValid = true;
        let firstEmptySelect = null;

        $('select.select_' + section_id).each(function() {
            if ($(this).is(':visible') && !$(this).closest('.hid').length && 
                (!$(this).val() || $(this).val().length === 0)) {
                isValid = false;
                $(this).addClass('is-invalid');
                
                if (!firstEmptySelect) {
                    firstEmptySelect = this;
                }
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        if (!isValid) {
            if (firstEmptySelect) {
                $(firstEmptySelect).focus();
            }
            return false;
        }

        $('#pro_form_' + section_id).submit();
        return true;
    }

    // Show edit alert (SAME)
    function showEditAlert(sectionId) {
        $('#edit-alert-' + sectionId).removeClass('d-none');
    }

    // Load survey from URL parameter (SAME)
    function getSurveyIdFromURLAndLoad() {
        const urlParams = new URLSearchParams(window.location.search);
        const surveyId = urlParams.get('id'); 
        const filterContentSurveys = document.querySelectorAll('#filter-content-survey');
        
        filterContentSurveys.forEach((filterContent) => {
            const profileQuesDataDivs = filterContent.querySelectorAll('.profile_ques_data');
            profileQuesDataDivs.forEach((profileDiv) => {
                const targetDiv = profileDiv.querySelector(`.load_${surveyId}`);
                if (targetDiv) {
                    let targetDivId = targetDiv.id;
                    let number = targetDivId.split('-')[1]; 
                    loadSurveyEss(number); 
                }
            });
        });
    }
    window.onload = getSurveyIdFromURLAndLoad;        
            function scrollTabs(amount) {
        const row = document.querySelector('.li-tab-row');
        row.scrollBy({ left: amount, behavior: 'smooth' });
    }

    // Optional: Hide arrows if not needed
    function updateScrollArrows() {
        const row = document.querySelector('.li-tab-row');
        const leftArrow = document.querySelector('.scroll-left');
        const rightArrow = document.querySelector('.scroll-right');

        if (!row || !leftArrow || !rightArrow) return;

        // Show/hide arrows based on scroll position
        leftArrow.style.display = row.scrollLeft > 10 ? 'block' : 'none';
        rightArrow.style.display = row.scrollLeft + row.offsetWidth < row.scrollWidth - 10 ? 'block' : 'none';
    }

    // Run on page load and on scroll
    window.addEventListener('load', updateScrollArrows);
    window.addEventListener('resize', updateScrollArrows);
    document.querySelector('.li-tab-row').addEventListener('scroll', updateScrollArrows);

</script>
@endpush